[gd_scene load_steps=19 format=3 uid="uid://136uv5dx8vyh"]

[ext_resource type="Texture2D" uid="uid://bbe23562jc1be" path="res://Art/NewArt/BirdSprite.png" id="1_n8ynp"]

[sub_resource type="GDScript" id="GDScript_n8ynp"]
script/source = "extends AnimatableBody2D

@export var players_needed: int = 2
@export var speed: float = 160.0

@export var origin: Vector2
@export var max_pos: Vector2
@export var use_start_as_origin: bool = true

@export var ping_pong: bool = false

var _riders := {}
var _prev_pos := Vector2.ZERO
var _target := Vector2.ZERO
@onready var sprite: AnimatedSprite2D = $AnimatedSprite2D

func _ready() -> void:
	if use_start_as_origin or origin == Vector2.ZERO:
		origin = global_position
	_target = origin
	_prev_pos = global_position
	process_priority = -10
	set_physics_process(true)
	# Mirror moving_platform: use Area2D as rider sensor
	if has_node(\"Area2D\"):
		var a = $Area2D
		if a:
			a.body_entered.connect(_player_on_platform)
			a.body_exited.connect(_player_left_platform)

func _player_on_platform(body: Node2D) -> void:
	if body.is_in_group(\"players\"):
		_riders[body.get_instance_id()] = body

func _player_left_platform(body: Node2D) -> void:
	_riders.erase(body.get_instance_id())

func _physics_process(delta: float) -> void:
	if multiplayer.is_server():
		if ping_pong:
			_update_ping_pong(delta)
		else:
			_update_rider_gated(delta)

	var new_pos := global_position
	var actual_v = (new_pos - _prev_pos) / maxf(delta, 1e-6)
	constant_linear_velocity = actual_v
	_prev_pos = new_pos
	# Flip based on intended horizontal motion toward current target to avoid relying on replicated velocity
	var intended := _target - global_position
	if abs(intended.x) > 0.01:
		# Default art faces left; flip when moving right
		sprite.flip_h = intended.x > 0.0

	# Stop tiny jitter at ends when weâ€™re basically at target
	if new_pos.distance_to(_target) <= 0.5 and (ping_pong or _riders.size() < players_needed):
		constant_linear_velocity = Vector2.ZERO


# ----- Movement strategies -----

func _update_rider_gated(delta: float) -> void:
	# Move toward max_pos if enough riders, else back to origin.
	var enough := _riders.size() >= players_needed
	_target = max_pos if enough else origin
	_move_toward_target(delta)

func _update_ping_pong(delta: float) -> void:
	var eps := 0.5
	if global_position.distance_to(origin) <= eps:
		_target = max_pos
	elif global_position.distance_to(max_pos) <= eps:
		_target = origin
	_move_toward_target(delta)

func _move_toward_target(delta: float) -> void:
	var to_target := _target - global_position
	var dist := to_target.length()
	if dist <= 0.5:
		global_position = _target
		return
	var step := speed * delta
	if step >= dist:
		global_position = _target
	else:
		global_position += to_target.normalized() * step
"

[sub_resource type="AtlasTexture" id="AtlasTexture_6ybag"]
atlas = ExtResource("1_n8ynp")
region = Rect2(0, 32, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_r4bug"]
atlas = ExtResource("1_n8ynp")
region = Rect2(16, 32, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_dwvse"]
atlas = ExtResource("1_n8ynp")
region = Rect2(32, 32, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_um0yu"]
atlas = ExtResource("1_n8ynp")
region = Rect2(0, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_qumqm"]
atlas = ExtResource("1_n8ynp")
region = Rect2(16, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_dhhtj"]
atlas = ExtResource("1_n8ynp")
region = Rect2(32, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_etahv"]
atlas = ExtResource("1_n8ynp")
region = Rect2(48, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_rma7a"]
atlas = ExtResource("1_n8ynp")
region = Rect2(64, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_6mpt5"]
atlas = ExtResource("1_n8ynp")
region = Rect2(80, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_7fw58"]
atlas = ExtResource("1_n8ynp")
region = Rect2(96, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_74q3a"]
atlas = ExtResource("1_n8ynp")
region = Rect2(112, 16, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_ime5q"]
atlas = ExtResource("1_n8ynp")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_hlh0j"]
atlas = ExtResource("1_n8ynp")
region = Rect2(16, 0, 16, 16)

[sub_resource type="SpriteFrames" id="SpriteFrames_ysuju"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_6ybag")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_r4bug")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_dwvse")
}],
"loop": true,
"name": &"Eating",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_um0yu")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_qumqm")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_dhhtj")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_etahv")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_rma7a")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_6mpt5")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7fw58")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_74q3a")
}],
"loop": true,
"name": &"Flying",
"speed": 20.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_ime5q")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_hlh0j")
}],
"loop": true,
"name": &"Idle",
"speed": 1.0
}]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_sensor"]
size = Vector2(12, 12)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_n8ynp"]
size = Vector2(6, 5)

[node name="BlueBird" type="AnimatableBody2D"]
script = SubResource("GDScript_n8ynp")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
sprite_frames = SubResource("SpriteFrames_ysuju")
animation = &"Flying"
autoplay = "Flying"
frame_progress = 0.563183

[node name="Area2D" type="Area2D" parent="."]
visible = false

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area2D"]
visible = false
position = Vector2(0, -4)
shape = SubResource("RectangleShape2D_sensor")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
visible = false
shape = SubResource("RectangleShape2D_n8ynp")
